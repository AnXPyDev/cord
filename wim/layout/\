Layout = require "cord.wim.layout.base"
Negotiator = require "cord.wim.layout.negotiator"
Vector = require "cord.math.vector"
crush = (require "cord.table").crush

att = {
	top: 1
	left: 1
	start: 1
	center: 2
	middle: 2
	bottom: 3
	finish: 3
	right: 3
	end: 3
}

dtt = {
	x: "x"
	y: "y"
	horizontal: "x"
	vertical: "y"
}

opposite_c = (c) ->
	if c == "x"
		return "y"
	return "x"

class Align extends Layout
	@__name: "cord.wim.layout.align"
	
	defaults: crush({}, Layout.defaults, {
		direction: "horizontal"
	})

	new: (config, ...)
		super(config, ...)


		init_child = (child) ->
			if not child
				return
			child\request_property("layout_align", "center")
			child\request_property("layout_justify", "center")
			child\request_property("size_priority", 1)
			child\request_property("flexible", false)

		for i, child in ipairs @children
			init_child(child)

		@connect_signal("added_child", request_child_properties)

	apply_layout: =>
		context = @\get_size!
		dir = @data\get("direction")

		cp = dtt[dir]
		cs = opposite_c(cp)

		avl_space = context\copy!

		results = {{}, {} ,{}}
		flexible = {}

		for i, child in ipairs @children
			ix = att[child.data\get("layout_align")] or 2

			if child.data\get("preferred_visible") == false
				table.insert(results[ix], {child})
				continue

			if child.data\get("flexible")
				table.insert(flexible, child)
				table.insert(results[ix], {child})
				continue
			
			child_size = child\get_size("layout")

			if child_size.x > avl_space.x or child_size.y > avl_space.y
				table.insert(results[ix], {child})
			
			avl_space[cp] -= child_size[cp]
			
			table.insert(results[ix], {child, child_size})
		
		negotiation = Negotiator(cp, size, avl_space, flexible)

		start_bound = 0
		stop_bound = 0

		place_child = (child, size, corner) ->
			j = att[child.data\get("layout_justify")] - 1

			child\set_pos(Vector(
				corner,
				(context[cs] - size[cs]) * 0.5 * j
			))

		for i, e in ipairs results[1]
			local size = e[2]

			e[1]\mute_signal("geometry_changed::layout")
		
			if not size
				size = negotiation[e[1]]
				if size
					e[1]\set_size(size)
				else
					e[1]\set_visible(false)
					continue
			
			e[1]\set_visible(true)

			place_child(e[1], size, start_bound)
			
			start_bound += size[cp]

			e[1]\unmute_signal("geometry_changed::layout")

		for i = #results[3], 1, -1
			e = results[3][i]
			local size = e[2]

			e[1]\mute_signal("geometry_changed::layout")
		
			if not size
				size = negotiation[e[1]]
				if size
					e[1]\set_size(size)
				else
					e[1]\set_visible(false)
					continue
			
			e[1]\set_visible(true)

			
			stop_bound += size[cp]
			
			place_child(e[1], size, stop_bound)

			e[1]\unmute_signal("geometry_changed::layout")

	
		center_positions = {}
		center_size = 0
		for i, e in ipairs results[2]
			local size = e[2]

			e[1]\mute_signal("geometry_changed::layout")
		
			if not size
				size = negotiation[e[1]]
				if size
					e[1]\set_size(size)
				else
					e[1]\set_visible(false)
					continue
			
			e[1]\set_visible(true)

			center_size += size[cp]
			
			e[1]\unmute_signal("geometry_changed::layout")



